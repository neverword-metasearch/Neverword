<script>
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    const errorMsg = document.getElementById('errorMsg');
    const results = document.getElementById('results');

    // ΝΕΕΣ ΑΝΑΦΟΡΕΣ ΚΟΥΜΠΙΩΝ
    const searchAllEnBtn = document.getElementById('searchAllEnBtn');
    const searchAllGrBtn = document.getElementById('searchAllGrBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');

    // IDs που ΔΕΝ φορτώνουν σε iframe (όπως μου έδωσες)
    const BLOCKED_IDS = [1, 2, 4, 6, 7, 8, 10, 11, 13, 14, 15, 17, 24, 25, 26, 28, 29, 34, 35, 40];

    // ΚΑΤΗΓΟΡΙΟΠΟΙΗΣΗ IDs ΓΙΑ ΤΑ ΝΕΑ ΚΟΥΜΠΙΑ
    // Bilingual: 5, 1, 2
    // English: 6, 7, 8, 9, 11, 12, 13, 14, 16, 17, 18, 19
    // Collocations (English): 27, 28
    // Technical Terms (EN): 30, 32
    // EU Law (EN): 34
    // Greek: 22, 24
    // Technical Terms (GR): 31, 33
    // EU Law (GR): 35

    // IDs για Αγγλικά (Bilingual + English + Collocations + Technical EN + EU Law EN)
    const ENGLISH_IDS = [5, 1, 2, 6, 7, 8, 9, 11, 12, 13, 14, 16, 17, 18, 19, 27, 28, 30, 32, 34, 40];
    // IDs για Ελληνικά (Bilingual + Greek + Technical GR + EU Law GR)
    const GREEK_IDS = [5, 1, 2, 22, 24, 31, 33, 35];

    // -- Helper για save/restore scroll --
    const SCROLL_KEY = 'nw_scrollY';

    function saveScrollPosition() {
        try {
            sessionStorage.setItem(SCROLL_KEY, String(window.scrollY || 0));
        } catch (e) {
            // ignore if storage not available
        }
    }

    function restoreScrollPosition() {
        try {
            const v = sessionStorage.getItem(SCROLL_KEY);
            if (v !== null) {
                const y = parseInt(v, 10);
                if (!isNaN(y)) {
                    // μικρό timeout για να σιγουρευτούμε ότι έχει τελειώσει τυχ. rendering
                    setTimeout(() => { window.scrollTo(0, y); }, 10);
                }
                sessionStorage.removeItem(SCROLL_KEY);
            }
        } catch (e) { /* ignore */ }
    }

    // restore όταν η σελίδα "εμφανίζεται" (pageshow καλύπτει και BFCache cases)
    window.addEventListener('pageshow', restoreScrollPosition);
    // safety: αν η καρτέλα γίνει visible
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') restoreScrollPosition();
    });

    // ΣΥΝΑΡΤΗΣΕΙΣ ΓΙΑ ΤΑ ΝΕΑ ΚΟΥΜΠΙΑ
    function toggleCheckboxes(ids, forceState = null) {
        const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
        allCheckboxes.forEach(checkbox => {
            const dictId = parseInt(checkbox.dataset.dictId, 10);
            if (ids.includes(dictId)) {
                checkbox.checked = forceState !== null ? forceState : !checkbox.checked;
            }
        });
    }

    function selectAllEnglish() {
        // Πρώτα καθαρίζουμε όλα τα checkboxes
        clearAll();
        // Μετά επιλέγουμε τα αγγλικά
        toggleCheckboxes(ENGLISH_IDS, true);
    }

    function selectAllGreek() {
        // Πρώτα καθαρίζουμε όλα τα checkboxes
        clearAll();
        // Μετά επιλέγουμε τα ελληνικά
        toggleCheckboxes(GREEK_IDS, true);
    }

    function clearAll() {
        const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    }

    // EVENT LISTENERS
    searchBtn.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') performSearch();
    });

    searchAllEnBtn.addEventListener('click', selectAllEnglish);
    searchAllGrBtn.addEventListener('click', selectAllGreek);
    clearAllBtn.addEventListener('click', clearAll);


    function performSearch() {
        const term = searchInput.value.trim();
        if (!term) {
            showError('Παρακαλώ εισάγετε μια λέξη για αναζήτηση.');
            return;
        }

        const selected = [];
        const allCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');

        allCheckboxes.forEach(checkbox => {
            const urlTemplate = checkbox.value;
            const label = checkbox.nextElementSibling.textContent.trim();
            const idAttr = checkbox.dataset.dictId;
            if (urlTemplate && idAttr) {
                const dictId = parseInt(idAttr, 10);
                const searchUrl = urlTemplate.replace(/WORD/g, encodeURIComponent(term));
                selected.push({ id: dictId, label, url: searchUrl });
            }
        });

        if (selected.length === 0) {
            showError('Παρακαλώ επιλέξτε τουλάχιστον ένα λεξικό πριν κάνετε αναζήτηση.');
            return;
        }

        displayResults(selected);
        /* Αφαιρούμε τη γραμμή που εμφάνιζε το backToTop */
        results.scrollIntoView({ behavior: 'smooth' });
    }

    function displayResults(dictionaries) {
        results.innerHTML = '';

        const embedList = [];
        const blockedList = [];

        dictionaries.forEach(dict => {
            if (BLOCKED_IDS.includes(dict.id)) {  // Array.includes [web:161]
                blockedList.push(dict);
            } else {
                embedList.push(dict);
            }
        });

        // 1) Πρώτα τα κανονικά iframes
        embedList.forEach((dict, index) => {
            const container = document.createElement('div');
            container.className = 'iframe-container';

            const header = document.createElement('div');
            header.className = 'iframe-header';

            const titleSpan = document.createElement('span');
            titleSpan.className = 'iframe-header-title';
            titleSpan.textContent = (index + 1) + '. ' + dict.label;

            const button = document.createElement('button');
            button.className = 'open-tab-btn';
            button.textContent = 'Άνοιγμα σε νέα καρτέλα';
            button.addEventListener('click', () => {
                // αποθηκεύουμε το scroll πριν ανοίξουμε νέο tab
                saveScrollPosition();
                // άνοιγμα νέας καρτέλας όπως πριν
                window.open(dict.url, '_blank', 'noopener');
            });

            header.appendChild(titleSpan);
            header.appendChild(button);
            container.appendChild(header);

            const iframe = document.createElement('iframe');
            iframe.src = dict.url;
            iframe.title = dict.label;
            iframe.style.opacity = '0';
            iframe.onload = function () {
                iframe.style.opacity = '1';
            };

            container.appendChild(iframe);
            results.appendChild(container);
        });

        // 2) Μετά, μικρές κάρτες για τα blocked στο τέλος
        if (blockedList.length > 0) {
            const title = document.createElement('div');
            title.className = 'blocked-results-title';
            title.textContent = 'Λεξικά που ανοίγουν μόνο σε νέα καρτέλα:';
            results.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'blocked-grid';

            blockedList.forEach(dict => {
                const card = document.createElement('div');
                card.className = 'blocked-card';

                const name = document.createElement('div');
                name.className = 'blocked-name';
                name.textContent = dict.label;

                const info = document.createElement('div');
                info.className = 'blocked-info';
                info.textContent = 'Αυτό το λεξικό δεν μπορεί να ενσωματωθεί στη σελίδα (iframe).';

                const btn = document.createElement('button');
                btn.className = 'blocked-btn';
                btn.textContent = 'Άνοιγμα σε νέα καρτέλα';
                btn.addEventListener('click', () => {
                    // αποθηκεύουμε το scroll πριν ανοίξουμε νέο tab
                    saveScrollPosition();
                    window.open(dict.url, '_blank', 'noopener');
                });

                card.appendChild(name);
                card.appendChild(info);
                card.appendChild(btn);
                grid.appendChild(card);
            });

            results.appendChild(grid);
        }
    }

    function showError(message) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 5000);
    }
</script>
